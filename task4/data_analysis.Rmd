---
title: "R Notebook"
output: html_notebook
---

```{r}

library(tidyverse)
library(readxl)
library(janitor)
library(here)

```

```{r}

candy <- read_csv(here("clean_data/candy_cleaned"))

candy

```

--------------------------------------------------------------------------------

Analysis questions
What is the total number of candy ratings given across the three years.
(Number of candy ratings, not the number of raters. Donâ€™t count missing values)

```{r}

# since ratings with NA values is already removed via the cleaning script, the 
# number of ratings is simplified and can be calculated as follows:

candy %>%
  summarise(num_ratings = n())

```

What was the average age of people who are going out trick or treating?

```{r}

candy %>% 
  filter(going_out == "Yes") %>%
  group_by(id) %>%
  summarise(avg_age = mean(age)) %>% 
  summarise(avg_age_pop = mean(avg_age, na.rm = T))

```


What was the average age of people who are not going trick or treating?

```{r}

candy %>% 
  filter(going_out == "No") %>%
  group_by(id) %>%
  summarise(avg_age = mean(age)) %>% 
  summarise(avg_age_pop = mean(avg_age, na.rm = T))

```


For each of joy, despair and meh, which candy bar received the most of these
ratings?

```{r}

candy %>%
  group_by(rating, candy_name) %>% 
  summarise(count = n()) %>% 
  slice_max(count)

```

How many people rated Starburst as despair?

```{r}

candy %>% 
  filter(candy_name == "starburst",
         rating == "DESPAIR") %>% 
  summarise(count = n())
  
  
```


For the next three questions, count despair as -1, joy as +1, and meh as 0.

What was the most popular candy bar by this rating system for each gender in the
dataset ?

```{r}

candy_scored <- candy %>% 
  mutate(score = case_when(
    rating == "JOY" ~ 1,
    rating == "DESPAIR" ~ -1,
    TRUE ~ 0
  ))

```

```{r}

candy_scored %>%
  filter(!is.na(gender)) %>% 
  group_by(gender, candy_name) %>%
  summarise(total_score = sum(score)) %>% 
  slice_max(total_score)

```


What was the most popular candy bar in each year?

```{r}

candy_scored %>% 
  group_by(year, candy_name) %>% 
  summarise(total_score = sum(score)) %>% 
  slice_max(total_score)

```


What was the most popular candy bar by this rating for people in US, Canada, UK,
and all other countries?

```{r}

candy_scored %>%
  filter(country == c("USA", "Canada", "UK", "Other")) %>% 
  group_by(country, candy_name) %>% 
  summarise(total_score = sum(score)) %>% 
  slice_max(total_score)

```

```{r}

candy_scored %>% 
  filter(country == "Other", id == "90278940") %>% 
  summarise(total_score = sum(score)) %>% 
  arrange(desc(total_score))

```

```{r}

candy_scored %>%
  filter(country == "USA") %>% 
  group_by(candy_name) %>% 
  summarise(JOY = sum(str_detect(rating, "JOY")),
            MEH = sum(str_detect(rating, "MEH")),
            DESPAIR = sum(str_detect(rating, "DESPAIR")),
            total_score = JOY - DESPAIR
  ) %>% 
  arrange(desc(total_score))

```

```{r}

candy_scored %>%
  filter(!is.na(country)) %>% 
  group_by(country, candy_name) %>% 
  # max total_score is the best, however if there is a tie then the candy with
  # the lowest number of votes wins (i.e. highest proportion of "JOY" votes)
  summarise(total_score = sum(score),
            num_votes = n()) %>%
  arrange(desc(total_score), num_votes) %>%
  slice_max(total_score, with_ties = F) %>% 
  select(country, candy_name)

```

```{r}

candy_scored %>%
  filter(country == "Canada") %>% 
  group_by(country, candy_name) %>% 
  # max total_score is the best, however if there is a tie then the candy with
  # the lowest number of votes wins (i.e. highest proportion of "JOY" votes)
  summarise(total_score = sum(score),
            num_votes = n()) %>%
  arrange(desc(total_score), num_votes)

```

